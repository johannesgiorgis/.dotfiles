#!/usr/bin/env bash

set -e

start=$(date +%s)

export SUPPORT_DIR="${HOME}/.dotfiles/support"
source "${SUPPORT_DIR}/common-utilities.sh"

echo "${SCRIPT_BREAK}"
print_info "$0 Started"

tags="$1"

if [[ -z "$tags" ]]
then
    tags="all"
fi

if ! [ -x "$(command -v ansible)" ]
then
    echo "Installing ansible..."
    if [[ "$(uname)" == "Darwin" ]]
    then
        echo "On Mac..."
        brew install ansible #@2.9.6
        brew pin ansible
    else
        release_code=$(lsb_release -c -s)
        echo "On Linux '$release_code'..."
        if [[ "$release_code" == "bionic" ]]; then
            sudo apt-add-repository ppa:ansible/ansible -y
            sudo apt update
            sudo apt install ansible=2.9.9-1ppa~bionic -V -y
        elif [[ "$release_code" == "focal" ]]; then
            sudo apt update
            sudo apt install ansible -V -y
        else
            echo "ERROR: Unknown linux release code - '$release_code'. Exiting with error"
            exit 1
        fi
    fi
fi

#ansible-playbook -i ~/.dotfiles/hosts ~/.dotfiles/ansible/dotfiles.yml --ask-become-pass --tags "$tags"
ansible-playbook -i ~/.dotfiles/ansible/hosts ~/.dotfiles/ansible/dotfiles.yml --tags "$tags" #--ask-become-pass

end=$(date +%s)
runtime=$((end-start))
runtime_min=$(convert_seconds_to_min $runtime)

finished "$0 Completed with $runtime seconds ($runtime_min mins)"
echo "${SCRIPT_BREAK}"
